# Stripe決済付き 基本的なECサイト

これは、Node.js, Express, Stripe Checkout を使用して構築された、シンプルなECサイトのサンプルアプリケーションです。

## 概要

このアプリケーションは、いくつかの商品をリスト表示し、ユーザーが「購入する」ボタンをクリックするとStripeが提供する決済ページにリダイレクトして支払いを行うことができる、基本的なEC機能のデモンストレーションです。

## 主な機能

-   サーバーから動的に商品リストを読み込んで表示
-   Stripe Checkout と連携した決済機能
-   決済成功時・キャンセル時の結果表示ページ

## 技術スタック

-   **バックエンド**: Node.js, Express
-   **決済処理**: Stripe API
-   **フロントエンド**: HTML, CSS, JavaScript (ES6)
-   **その他**: `dotenv` (環境変数管理)

## セットアップと実行方法

### 1. 前提条件

-   [Node.js](https://nodejs.org/) (v14以降を推奨)
-   [Stripe](https://stripe.com/) アカウント

### 2. インストール

まず、このリポジトリをクローンします。

```bash
git clone https://github.com/your-username/basic-ec-with-stripe.git
cd basic-ec-with-stripe
```

次に、必要なnpmパッケージをインストールします。

```bash
npm install
```

### 3. 環境設定

StripeのAPIキーを設定する必要があります。プロジェクトのルートディレクトリに `.env` という名前のファイルを作成し、以下のように記述してください。

```
STRIPE_SECRET_KEY=sk_test_YOUR_SECRET_KEY
```

`sk_test_YOUR_SECRET_KEY` の部分を、ご自身のStripeテスト環境のシークレットキーに置き換えてください。キーは[Stripeダッシュボード](https://dashboard.stripe.com/test/apikeys)で確認できます。

### 4. アプリケーションの起動

以下のコマンドでサーバーを起動します。

```bash
npm start
```

コンソールに `Server is running on port 3000` と表示されれば成功です。

ブラウザで `http://localhost:3000` にアクセスしてください。

## アプリケーションの仕組み

1.  **商品表示**: ユーザーがトップページにアクセスすると、フロントエンドのJavaScriptがバックエンドの `/api/products` エンドポイントを呼び出し、商品情報を取得して画面に表示します。
2.  **決済開始**: ユーザーが「購入する」ボタンをクリックすると、フロントエンドは選択された商品のIDを `/create-checkout-session` エンドポイントにPOSTリクエストで送信します。
3.  **Checkoutセッション作成**: バックエンドサーバーはStripeのAPIを呼び出し、商品の価格やリダイレクト先URLを含む決済セッションを作成します。
4.  **リダイレクト**: バックエンドは作成されたセッションのURLをフロントエンドに返し、フロントエンドはユーザーをそのURL（Stripeの決済ページ）にリダイレクトします。
5.  **決済完了**: ユーザーが決済を完了すると、Stripeは `success_url` に指定されたページ (`/success.html`) にリダイレクトします。キャンセルした場合は `cancel_url` (`/cancel.html`) にリダイレクトされます。

## Next Steps

このアプリケーションをより実践的なECサイトへと発展させるため、以下の機能改善を計画しています。

### 1. ショッピングカート機能の実装
**目的:** 複数の商品をまとめて購入できるようにし、ユーザーの利便性を向上させます。

**主な手順:**
-   フロントエンドに「カートに入れる」ボタンを設置します。
-   ブラウザの`localStorage`などを利用して、ページを移動してもカートの中身が保持されるようにします。
-   カート内の商品一覧を確認・変更できるページ（`/cart`）を作成します。
-   バックエンドの決済API（`/create-checkout-session`）を改修し、カート内のすべての商品を一度に決済できるようにします。

### 2. 在庫管理機能の導入
**目的:** 商品の在庫を管理し、売り切れ商品の販売を防ぎます。

**主な手順:**
-   商品データに`stock`（在庫数）の項目を追加します。
-   ユーザーが決済に進む際に、商品の在庫が十分にあるかを確認するロジックを追加します。
-   決済が正常に完了したことをStripe Webhook（`checkout.session.completed`イベント）で受け取り、非同期で対象商品の在庫数を減らす処理を実装します。
-   在庫がゼロになった商品は、フロントエンドで「売り切れ」と表示します。

### 3. 商品管理機能の強化 (データベース化)
**目的:** ソースコードを直接編集することなく、商品の追加や更新ができるようにし、運用性を高めます。

**主な手順:**
-   `sqlite3`などのデータベースを導入し、商品情報を格納するテーブルを作成します。
-   サーバー起動時に、商品データを配列ではなくデータベースから取得するように`server.js`を修正します。
-   将来的には、ブラウザから商品を管理できる管理者向け画面の作成も視野に入れます。
